var counters = {};
var cy;
var table_feat_created = false;
var table_target_created = false;
var inputs_layers = {};
var mode, loaded_input;
var api;
Array.prototype.contains = function (element) {
    return this.indexOf(element) > -1;
};

document.addEventListener('DOMContentLoaded', function () {
    $('#inp').val(appConfig.m_name);
    $('#submit').prop('disabled', true);
    create_layers(corelayers);


    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: appConfig.cy_model.elements,
        style: cyto_styles
    });
    cy.userZoomingEnabled(false);

    var expandCollapse_defaults = {
        layoutBy: null,
        fisheye: false,
        animate: false,
        ready: function () {
        },
        undoable: true, // and if undoRedoExtension exists,
        cueEnabled: true, // Whether cues are enabled
        expandCollapseCuePosition: function (node) {
            var offset = 1;
            var size = (15 * cy.zoom()) / 2;
            api.setOption('expandCollapseCueSize', 15 * cy.zoom());

            var x = node.position('x') - node.width() / 2 - parseFloat(node.css('padding-left'))
                + parseFloat(node.css('border-width')) + size + offset;
            var y = node.position('y') - node.height() / 2 - parseFloat(node.css('padding-top'))
                + parseFloat(node.css('border-width')) + size + offset;

            cueCenter = {
                x: x,
                y: y
            };
            return cueCenter;
        }, // default cue position is top left you can specify a function per node too
        expandCollapseCueSize: 15 * cy.zoom(),
        // size of expand-collapse cue
        expandCollapseCueLineSize: 1, // size of lines used for drawing plus-minus icons
        collapseCueImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAgAElEQVR4Xu3df9BnV30X8HPvs7spJoQEGn+ixWpVlCZoKYXaIjBOIA1kn++zfUZonQEHSeuoOJaOdeJIF9HpMCqoo/0Rqk07lf6x3e/32Y1MJIXOAo5FZ6DAwMAUtFDb2vAj4VdLdvf73Os8mAzJZnef+73fe+733HNe+Zd7zvmc1+csn/fuZjdV8A8BAgQIECBQnEBV3I1dmAABAgQIEAgCgEdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIECBAgECBAgJAgU13ZQIECBAgIAB4AwQIECBAoEABAaDAprsyAQIECBAQALwBAgQIECBQoIAAUGDTXZkAAQIECAgA3gABAgQIEChQQAAosOmuTIAAAQIEBABvgAABAgQIFCggABTYdFcmQIAAAQICgDdAgAABAgQKFBAACmy6KxMgQIAAAQHAGyBAgAABAgUKCAAFNt2VCRAgQICAAOANECBAgACBAgUEgAKb7soECBAgQEAA8AYIEDgQqHZ3d689f/789ddcc82RCxcutMeOHXs4hLB18eLFb9rf36+qqjofQvjK2bNnvxpCaLERIDBtAQFg2v1TPYGVBHZ3d7eWy+Wzqqp6XtM0N1dV9cyqqp6xv7//9Lquj3bZrGmaC1tbW7/TNM3/CiF8vKqqD4UQfm2xWHxCMOgi6BsCaQgIAGn0QRUEogns7u5et1wuX9a27XZVVbeGEG6MdNgDIYR3VlW1d/311993zz33HPwKgn8IEEhUQABItDHKIrCmQLWzs/Pdbdve2TTNbl3XT1pzv1WXfzmE8EshhJ9aLBYfXnWx7wkQiC8gAMQ3dgKBMQUOBv/LQwh3tW37XWMefJWz3h1CeNNisXhPIvUogwCBg3/xhwIBAnkIzGaz51dV9daEBv+lsPeHEF6/WCw+moe4WxCYtoAAMO3+qZ5A2N7evqGu63/Vtu1rUudomma/ruu3LpfLH7/33nv/IPV61UcgZwEBIOfuulv2Ajs7Oy/a39//hbqunz6xy/5G27Y/sLe394GJ1a1cAtkICADZtNJFChOotre3/0nbtm+s67qe4t2bprlY1/XrFovFz/jjg1PsoJqnLiAATL2D6i9OYHd390kXL178uaqq/kYOl6+q6qcefPDB1507d26Zw33cgcBUBASAqXRKnQRCCHfccceTt7a2zoYQXpgZyJmnPOUpr/B3B2TWVddJWkAASLo9iiPwDYHd3d2nLJfL+0IIz8/RpW3bd95www3bQkCO3XWnFAUEgBS7oiYClwgcDP8LFy7817qun5czjhCQc3fdLTUBASC1jqiHQKHD/9FrCwF+CBAYR0AAGMfZKQR6CZTyM/9LcYSAXs/FIgIrCQgAK3H5mMB4AqUOf78SMN4bc1LZAgJA2f13+0QFSh/+QkCiD1NZWQkIAFm102VyEDD8H99Fvx2Qw6t2hxQFBIAUu6KmYgUM/8u3Xggo9oeEi0cUEAAi4tqawCoChv/VtYSAVV6TbwkcLiAAHG7kCwLRBQz/bsRCQDcnXxHoIiAAdFHyDYGIAob/arhCwGpeviZwJQEBwNsgsEEBw78fvhDQz80qAo8VEAC8BwIbEjD814MXAtbzs5qAAOANENiAgOE/DLoQMIyjXcoUEADK7Ltbb1DA8B8WXwgY1tNu5QgIAOX02k0TEDD84zRBCIjjate8BQSAvPvrdgkJGP5xmyEExPW1e34CAkB+PXWjBAUM/3GaIgSM4+yUPAQEgDz66BYJCxj+4zZHCBjX22nTFRAApts7lU9A4GD47+/vv7Nt2++aQLnZlCgEZNNKF4koIABExLV12QKG/2b7LwRs1t/p6QsIAOn3SIUTFDD802iaEJBGH1SRpoAAkGZfVDVhAcM/reYJAWn1QzXpCAgA6fRCJRkIGP5pNlEISLMvqtqsgACwWX+nZyRg+KfdTCEg7f6obnwBAWB8cydmKGD4T6OpQsA0+qTKcQQEgHGcnZKxgOE/reYKAdPql2rjCQgA8WztXICA4T/NJgsB0+ybqocVEACG9bRbQQKG/7SbLQRMu3+qX19AAFjf0A4FChj+eTRdCMijj27RT0AA6OdmVcEChn9ezRcC8uqn23QXEAC6W/mSQDD883wEQkCefXWrqwsIAF4IgY4Chn9HqIl+JgRMtHHK7i0gAPSms7AkAcO/jG4LAWX02S3/v4AA4CUQOETA8C/riQgBZfW75NsKACV3390PFTD8DyXK8gMhIMu2utQlAgKAJ0HgCgKGf9lPQwgou/8l3F4AKKHL7riygOG/MlmWC4SALNvqUo8ICACeAoFLBAx/T+KxAkKA95CrgACQa2fdq5fAwfBfLpf3hxCe22sDi7IUEAKybGvxlxIAin8CAB4VMPy9hasJCAHeR24CAkBuHXWfXgKGfy+24hYJAcW1POsLCwBZt9fluggY/l2UfPOogBDgLeQiIADk0kn36CVg+PdiK36REFD8E8gCQADIoo0u0UfA8O+jZo1fCfAGchEQAHLppHusJGD4r8Tl4ysI+JUAT2PKAgLAlLun9l4Chn8vNouEAG8gMwEBILOGus7VBQx/LySGgF8JiKFqz9gCAkBsYfsnI2D4J9OKLAsRArJsa9aXEgCybq/LPSpg+HsLYwgIAWMoO2MoAQFgKEn7JCtg+CfbmiwLEwKybGuWlxIAsmyrS/mZvzewSQEhYJP6zu4qIAB0lfLd5AT8zH9yLcuqYCEgq3ZmeRkBIMu2upTh7w2kICAEpNAFNVxJQADwNrITMPyza+mkLyQETLp9WRcvAGTd3vIuZ/iX1/Mp3FgImEKXyqtRACiv59ne2PDPtrVZXEwIyKKNWV1CAMiqneVeZnt7+4aqqt4ZQnhuuQpunrqAEJB6h8qqTwAoq99Z3tbwz7Kt2V5KCMi2tZO7mAAwuZYp+LEChr/3MEUBIWCKXcuvZgEgv54WcyPDv5hWZ3lRISDLtk7qUgLApNql2EcFDH9vIQcBISCHLk73DgLAdHtXbOWGf7Gtz/LiQkCWbZ3EpQSASbRJkX7m7w3kLCAE5NzddO8mAKTbG5VdIuBn/p5EzgJCQM7dTfNuAkCafVGV4e8NFCggBBTY9A1eWQDYIL6juwn4mX83J1/lISAE5NHHKdxCAJhClwqu0fAvuPkFX10IKLj5I15dABgR21GrCRj+q3n5Oi8BISCvfqZ4GwEgxa6oKRj+HgGBEIQAryCmgAAQU9fevQQM/15sFmUqIARk2tgEriUAJNAEJXxDwPD3Ggg8UUAI8CpiCAgAMVTt2UvA8O/FZlEhAkJAIY0e8ZoCwIjYjrqygOHvdRA4XEAIONzIF90FBIDuVr6MJGD4R4K1bZYCQkCWbd3IpQSAjbA79FEBw99bILC6gBCwupkVTxQQALyKjQkcDP8Qwv1VVX3nxopwMIGJCggBE21cQmULAAk1o6RSDP+Suu2usQSEgFiyZewrAJTR56Ruafgn1Q7FTFxACJh4AzdYvgCwQfwSjzb8S+y6O8cWEAJiC+e5vwCQZ1+TvJXhn2RbFJWJgBCQSSNHvIYAMCJ2yUcZ/iV3393HEhACxpLO4xwBII8+Jn0Lwz/p9iguMwEhILOGRryOABAR19bh6/9VP3/Uz0sgMK6AEDCu91RPEwCm2rkJ1G34T6BJSsxWQAjItrWDXUwAGIzSRo8VMPy9BwKbFxACNt+DlCsQAFLuzkRrM/wn2jhlZykgBGTZ1kEuJQAMwmiTRwUMf2+BQHoCQkB6PUmhIgEghS5kUoPhn0kjXSNLASEgy7audSkBYC0+i/3M3xsgMB0BIWA6vRqjUgFgDOXMz/Az/8wb7HpZCQgBWbVzrcsIAGvxWWz4ewMEpicgBEyvZzEqFgBiqBayp+FfSKNdM0sBISDLtq50KQFgJS4f+z1/b4BAPgJCQD697HMTAaCPWuFr/My/8Afg+lkJCAFZtXOlywgAK3H52PD3BgjkJyAE5NfTLjcSALoo+ebrAoa/h0AgXwEhIN/eXulmAkB5Pe9140eG/69UVfWcXhtYRIBA8gJCQPItGrRAAWBQzjw3M/zz7KtbEbicgBBQzrsQAMrpda+bGv692CwiMGkBIWDS7etcvADQmaq8Dw3/8np+yY0/3TTN9XVdP7V4iQIBhID8my4A5N/jXjc0/HuxZbOoqqrfDCG8qGmaG9u2fbcQkE1rV7qIELAS1+Q+FgAm17L4BRv+8Y1TPuHR4T+fzz9zUOf29vazhYCUOxa3NiEgru8mdxcANqmf4NmGf4JNGbGkS4f/o0cLASM2IcGjhIAEmzJASQLAAIi5bGH459LJfve40vAXAvp55rZKCMitoyEIAPn1tNeNDP9ebNksOmz4CwHZtHqtiwgBa/Elt1gASK4l4xdk+I9vntKJXYe/EJBS1zZXixCwOfuhTxYAhhad2H6G/8QaNnC5qw5/IWDgBkx0OyFgoo27pGwBII8+9rqF4d+LLZtFfYe/EJDNE1jrIkLAWnxJLBYAkmjD+EUY/uObp3TiusNfCEipm5urRQjYnP0QJwsAQyhObA/Df2ING7jcoYa/EDBwYya6nRAw0cYFfwpgup3rWbnh3xMuk2VDD38hIJOHseY1hIA1ATe03K8AbAh+E8ca/ptQT+fMWMNfCEinx5usRAjYpH6/swWAfm6TW2X4T65lgxYce/gLAYO2a7KbCQHTap0AMK1+9arW8O/Fls2isYa/EJDNk1nrIkLAWnyjLhYARuUe/7Dbb7/9xqNHj95fVdVzxj/diZsWGHv4CwGb7nga5wsBafThsCoEgMOEJvy/G/4Tbt4ApW9q+AsBAzQvgy2EgPSbKACk36NeFRr+vdiyWbTp4S8EZPOU1rqIELAWX/TFAkB04vEPMPzHN0/pxFSGvxCQ0qvYXC1CwObsDztZADhMaGL/u+E/sYYNXG5qw18IGLjBE91OCEizcQJAmn3pVZXh34stm0WpDn8hIJsnttZFhIC1+KIsFgCisI6/qeE/vnlKJ6Y+/IWAlF7L5moRAjZnf7mTBYC0+tGrGsO/F1s2i6Yy/IWAbJ7cWhcRAtbiG3SxADAo5/ibGf7jm6d04tSGvxCQ0uvZXC1CwObsH3uyAJBGH3pVYfj3Ystm0VSHvxCQzRNc6yJCwFp8gywWAAZhHH8Tw39885ROnPrwFwJSek2bq0UI2Jz9wckCwGb9e51u+Pdiy2ZRLsNfCMjmSa51ESFgLb61FgsAa/GNv9jwH988pRNzG/5CQEqva3O1CAGbsRcANuPe61TDvxdbNotyHf5CQDZPdK2LCAFr8fVaLAD0Yht/keE/vnlKJ+Y+/IWAlF7b5moRAsa1FwDG9e51muHfiy2bRaUM/0cbNpvNbmma5lfrun5qNk10kc4CQkBnqrU/FADWJoy7geEf1zf13Usb/kJA6i9ynPqEgHGcBYBxnHudYvj3YstmUanDXwjI5gmvdREhYC2+TosFgE5M439k+I9vntKJpQ9/ISCl17i5WoSAuPYCQFzfXrsfDP9jx479SgjhO3ptYNGkBQz/x7fPvxMw6ee8dvFCwNqEV9xAAIhn22tnw78XWzaLDP/Lt1IIyOaJ97qIENCL7dBFAsChRON9YPiPZ53iSYb/1bsiBKT4aserSQgY3loAGN60146Gfy+2bBYZ/t1aKQR0c8r1KyFg2M4KAMN69trN8O/Fls0iw3+1VgoBq3nl9rUQMFxHBYDhLHvtZPj3YstmkeHfr5VCQD+3XFYJAcN0UgAYxrHXLoZ/L7ZsFhn+67VSCFjPb+qrhYD1OygArG/YawfDvxdbNosM/2FaKQQM4zjVXYSA9TonAKzn12u14d+LLZtFhv+wrRQChvWc2m5CQP+OCQD97XqtNPx7sWWzyPCP00ohII7rVHYVAvp1SgDo59ZrleHfiy2bRYZ/3FYKAXF9U99dCFi9QwLA6ma9Vhj+vdiyWWT4j9NKIWAc51RPEQJW64wAsJpXr68N/15s2Swy/MdtpRAwrndqpwkB3TsiAHS36vWl4d+LLZtFhv9mWikEbMY9lVOFgG6dEAC6OfX6yvDvxZbNIsN/s60UAjbrv+nThYDDOyAAHG7U6wvDvxdbNosM/zRaKQSk0YdNVSEEXF1eAIjwMg3/CKgT2tLwT6tZQkBa/Ri7GiHgyuICwMCv0fAfGHRi2xn+aTZMCEizL2NVJQRcXloAGPAFGv4DYk5wK8M/7aYJAWn3J3Z1QsAThQWAgV7d9vb2DVVVvSuE8B0DbWmbCQkY/tNolhAwjT7FqlIIeLysADDAS9vd3b1uuVzeH0J4/gDb2WJiAob/tBomBEyrXxGqPXvTTTd9/913330xwt6T2lIAWLNdL3zhC4/ceOONZ0MIt625leUTFDD8J9i0EIIQMM2+DVj1zy4WiztDCO2Ae05uKwFgzZYdP37839Z1/bo1t7F8ggKG/wSb9piShYBp92+A6l+/WCzeMsA+k91CAFijddvb26+squrta2xh6UQFDP+JNu6SsoWAPPrY5xZN0+xvbW29eD6fv7fP+hzWCAA9u7i9vf2Mqqo+EkJ4cs8tLJuogOE/0cZdoWwhIK9+rnKbpml+u6qqb9/b2/viKuty+VYA6NfJajabvTuE8KJ+y62aqoDhP9XOXb3ugxAQQjj4Mf20PG/oVlcR+PnFYvHqEoUEgB5dn81mrwoh3NNjqSUTFjD8J9y8DqULAR2QMv2kbdsX7e3tncv0ele8lgCwYscf+SN/nwoh/JEVl/p8wgKG/4Sbt0LpQsAKWHl9+pEjR478lVOnTu3nda2r30YAWLHbs9nsDSGEN664zOcTFjD8J9y8HqULAT3Q8ljy6sVi8fN5XKXbLQSAbk5f/2p3d/cpy+Xy0yGEG1ZY5tMJCxj+E27eGqULAWvgTXRpVVWfevDBB5957ty55USvsHLZAsAKZLPZ7EdCCP96hSU+nbCA4T/h5g1QuhAwAOLEtqiqanc+n//yxMruXa4A0JHu5MmT9Qc/+MFPbm1tfWvHJT6bsIDhP+HmDVi6EDAg5jS2et9isXjBNEpdv0oBoKPhbDZ78SN/TKjjCp9NVcDwn2rn4tQtBMRxTXXXuq7/3OnTpz+Zan1D1iUAdNTc2dn5ubZti/yzoh2JsvjM8M+ijYNfQggYnDTZDauqeuN8Pj+ZbIEDFiYAdMC88847jz7wwAO/V9f1Uzt87pOJChj+E23cSGULASNBb/iYpmk+eubMmW/fcBmjHC8AdGCezWbfE0J4X4dPfTJRAcN/oo0buWwhYGTwDR1XVdWfnM/nv72h40c7VgDoQL2zs3Oybdsf7/CpTyYoYPhPsGkbLFkI2CD+SEe3bfu39vb2sv/bXgWADg9qNpu9M4Rwa4dPfTIxAcN/Yg1LpFwhIJFGxCvjbYvF4s5426exswBweB+q48ePf97v/x8ONbUvDP+pdSyteoWAtPoxcDUfWiwWf3ngPZPbTgA4pCU7Ozt/rG3b302ucwpaS8DwX4vP4kcEhIA8n0LTNA8fO3bsutz/2wACwCHv9/jx499b1/V783zmZd7K8C+z77FuLQTEkt3svkeOHPmWU6dO/dZmq4h7ugBwiO9sNvvBEMIvxm2D3ccSMPzHki7rHCEgv343TfOCM2fOZP2nvwSAwwPAPwwhvCW/513ejQz/8no+5o2FgDG1RznrxGKxmI9y0oYOEQAOgd/e3v5nVVX90w31x7EDCRj+A0Ha5qoCQkA+D6Rt27+9t7f3H/O50RNvIgAc0t2dnZ03t237j3J+BLnfzfDPvcNp3U8ISKsfa1Tz9xaLxX9YY33ySwWAw38L4F+GEH40+U4q8LIChr+HsQkBIWAT6oOf+Q8Wi8W/G3zXhDYUAA4PAP8ihHBXQj1TSkcBw78jlM+iCAgBUVhH27Sqqh+ez+c/M9qBGzhIADg8APzjEMJPbKA3jlxDwPBfA8/SwQSEgMEoR9+obdsf2Nvb+6XRDx7xQAHg8ADw2hDC3SP2xFFrChj+awJaPqiAEDAo52ib1XX90tOnTx/8NfDZ/iMAHNLaEydOfF/TNO/I9gVkdjHDP7OGZnIdIWB6jazr+lmnT5/+2PQq716xAHCI1fHjx/9iXddZP4LuzyXtLw3/tPtTenVCwLRewJEjR5586tSpr06r6tWqFQAO8drd3T22XC5/P4RwZDVaX48pYPiPqe2svgJCQF+5cdc1TfOZM2fOPGPcU8c/TQDoYH7HHXd8aGtr65YOn/pkAwKG/wbQHdlbQAjoTTfmwrOLxeL4mAdu4iwBoIP6bDb76RDCD3X41CcjCxj+I4M7bhABIWAQxmibtG17197eXvZ/+ksA6PCEZrPZK0IIWf9xkA4MyX1i+CfXEgWtICAErIA18qdVVT1/Pp+/f+RjRz9OAOhAvru7e9NyuXwghMCrg9cYnxj+Yyg7I7bAiRMnbm6a5ldDCE+LfZb9Owt88aGHHrrp3Llzy84rJvqhgdaxcbPZ7D0hhBd0/NxnEQUM/4i4th5dQAgYnfywA39hsVi86rCPcvjfBYCOXdze3v47VVX9ZMfPfRZJwPCPBGvbjQoIARvlf9zhVVW9bD6fF/F3vwgAHd/d7bfffuOxY8f+bwjhmo5LfDawgOE/MKjtkhIQApJoxwMPPfTQ00v45f8DbQFghTc3m83uCSEU8UtDK7CM8qnhPwqzQzYsIARstgFt275pb2/vDZutYrzTBYAVrLe3t59dVdWvr7DEpwMIGP4DINpiMgJCwMZadb6qqj89n88PfqW3iH8EgBXbvLOzc7Zt25evuMznPQUM/55wlk1aQAgYv31VVf37+Xz+98c/eXMnCgAr2j/yZ3cPfhWA3Yp2q35u+K8q5vucBISA8bpZVdXBX/f+bSX97P9A1xDr8cZ2dnZ+tm3b1/RYaklHAcO/I5TPshYQAsZpb1VVb5jP528a57R0ThEAevTi5S9/+TcfOXLkE/7yjh54HZYY/h2QfFKMgBAQt9Vt237yhhtuuPmee+55OO5J6e0uAPTsyfb29iurqnp7z+WWXUHA8Pc0CDxRQAiI9irapmn+2pkzZ94X7YSENxYA1mjO8ePHf7Gu6x9cYwtLHyNg+HsOBK4sIAQM/zqqqvqJ+Xx+1/A7T2NHAWCNPu3u7l63XC7/ZwjhmWtsY+nBv4xSVb8ZQnjRfD7/DBACBC4vIAQM+jLe89BDD/31Uv7Sn8vJCQBrvqcTJ05823K5fH9d109dc6tilxv+xbbexXsICAE90C5ZcvD/OW3bPm+xWHx2/d2mu4MAMEDvZrPZ9zRNc39d108aYLuitjD8i2q3yw4kIASsBfmFEML3LhaLj6+1SwaLBYCBmjibzV7aNM3Zuq6PDrRl9tsY/tm32AUjCggBvXC/3Lbti/f29j7Qa3VmiwSAARs6m81e1jTNXAg4HNXwP9zIFwQOExACDhN63P/+5aqqXjKfz9+/0qqMPxYABm6uEHA4qOF/uJEvCHQVEAI6SRn+l2ESADq9ndU+EgKu7GX4r/aWfE2gi4AQcFWlr1RVdauf+T/RSADo8qOrxzfHjx8/+A8GnfbbAd/AM/x7PCRLCHQUEAIuC2X4X+X9CAAdf3D1+UwIMPz7vBtrCPQVEAIeJ2f4H/KQBIC+P9I6rhMC/CU/HZ+KzwgMIiAEfJ3R8O/wmgSADkjrflJyCPDL/uu+HusJrC5QeAgw/EtA1d8AAA1RSURBVDs+GQGgI9S6n+3s7Nyxv7//yyX9OwGG/7qvxnoC/QUKDQFfCSG8ZLFY/Fp/uXJWCgAj9rqkEGD4j/iwHEXgCgKFhQDDf8UfCQLAimDrfl5CCDD8130l1hMYTqCQEGD493gyAkAPtHWXzGaz403TnMrxtwMM/3Vfh/UEhhfIPAR8pWmal545c+a/Dy+X944CwIb6m2MIMPw39JgcS6CDQKYhwPDv0PsrfSIArIG37tJHfjvg4FcCjq2716bX7+/v/+8jR468eD6ff2bTtTifAIHLCxyEgIsXL75ra2vrpgyMvtw0zW1+5t+/kwJAf7tBVp44ceIly+VyMfH/lPDH9vf3bz179uzvDoJiEwIEogmcOHHiLzRN864Qwp+Idkj8jT//yH/Y54Pxj8r3BAEggd7u7Ox85/7+/sF/SviPJlDOqiW8u23b79/b2/viqgt9T4DAZgR2dnaevlwu/8vW1tYtm6lgrVN/Y39///azZ89+aq1dLA4CQCKP4OAH5P7+/sFvBzwvkZK6lPHWm2666cfuvvvui10+9g0BAukI7O7uXnfhwoW31XX9inSqunolVVXde/78+Ve94x3veGgqNadcpwCQUHd2d3ePLZfLN4YQfiyEpMPZ59u2fe3e3t5eQnxKIUBgdYFqe3v7tXVdv6Vt22tXXz7aivMhhLtuueWWf3Py5MlmtFMzP0gASLDBs9ns+U3T3F3X9bNSK69pmv/ctu3rz549+0BqtamHAIF+Atvb23+mqqqfDCHc2m+HqKv+W13XP3z69OmPRT2lwM0FgESbfueddx797Gc/+0NVVZ0MITwtgTI/0Lbtj+7t7Z1LoBYlECAwvEA1m81mVVW9uW3bPzv89ivv+H/atr3r2c9+9tv9rH9lu04LBIBOTJv76Lbbbrv+mmuu+btVVf1ICOGbx66kbdsP1nX9z2+++eYzfhCOre88AuMLHPzk43Of+9zfrKrqrk0EgbZtf6uu6zdff/31/+mee+55eHyBck4UACbS61e/+tXf9KUvfemVTdO8pq7rvxqz7KZpHq7relFV1U/P5/P3hRDamOfZmwCB9AROnjxZf/jDH/6+EMJrm6a5va7rrVhVNk3T1HX9rqqq3vbggw/unTt3bhnrLPt+Q0AAmOBr2NnZ+da2bXdCCC9rmua7h/grhZumefDgB2Dbtnvnz59/x3333fflCdIomQCBCAK7u7s37e/vH2/b9uCvMX9hXdfXrXtM0zRfq6rqvXVdn10ul3v+HpF1RVdfLwCsbpbUiltvvfXaa6+99jkhhOeGEP5S0zR/PoTwLSGEP3y5xP7Iz+5/J4Tw6aqqPt627Ufquv4fdV1/7NSpU/tJXU4xBAgkJ3DwWwRf+MIXbtnf339eVVUH/6LyM0MIf6ppmj9+ub/VtGmai3Vd/14I4eBvCf1E27YfPfj/nK997Wu/ft999x382/3+2ZCAALAh+BGOrW677bYnHz169EnXXHPNkRDChYcffvj377333j8Y4WxHECBQnkC1u7t77XK5/ENHjhw5ulwuL+7v73/t7NmzX/XbiGk+BgEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hQQANLsi6oIECBAgEBUAQEgKq/NCRAgQIBAmgICQJp9URUBAgQIEIgqIABE5bU5AQIECBBIU0AASLMvqiJAgAABAlEFBICovDYnQIAAAQJpCggAafZFVQQIECBAIKqAABCV1+YECBAgQCBNAQEgzb6oigABAgQIRBUQAKLy2pwAAQIECKQpIACk2RdVESBAgACBqAICQFRemxMgQIAAgTQFBIA0+6IqAgQIECAQVUAAiMprcwIECBAgkKaAAJBmX1RFgAABAgSiCggAUXltToAAAQIE0hT4fztb5MQolPF2AAAAAElFTkSuQmCC', // image of expand icon if undefined draw regular expand cue
        expandCueImage: 'data:image/png;base64,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', // image of collapse icon if undefined draw regular collapse cue
        expandCollapseCueSensitivity: 2 // sensitivity of expand-collapse cues
    };
    cy.expandCollapse(expandCollapse_defaults);
    api = cy.expandCollapse('get');
    let collapsed = [];


    add_icons_nodes();

    //Update counters (nodes names)
    cy.nodes().forEach(function (node) {
        counters[node.data().name.split('_')[0]] = parseInt(node.data().name.split('_')[1]);
    });
    counters['block'] = 0;


    let edge_bending_options = {
        // this function specifies the positions of bend points
        bendPositionsFunction: function (ele) {
            return ele.data('bendPointPositions');
        },
        // whether to initilize bend points on creation of this extension automatically
        initBendPointsAutomatically: true,
        // whether the bend editing operations are undoable (requires cytoscape-undo-redo.js)
        undoable: false,
        // the size of bend shape is obtained by multipling width of edge with this parameter
        bendShapeSizeFactor: 6,
        // whether to start the plugin in the enabled state
        enabled: true,
        // title of add bend point menu item (User may need to adjust width of menu items according to length of this option)
        addBendMenuItemTitle: "Add Bend Point",
        // title of remove bend point menu item (User may need to adjust width of menu items according to length of this option)
        removeBendMenuItemTitle: "Remove Bend Point",
        // whether the bend point can be moved by arrow keys
        moveSelectedBendPointsOnKeyEvents: function () {
            return true;
        }
    };

    cy.edgeBendEditing(edge_bending_options);
    center_layout(cy);


    let options = {
        // List of initial menu items
        menuItems: [
            {
                id: 'remove', // ID of menu item
                content: 'remove', // Display content of menu item
                tooltipText: 'remove', // Tooltip text for menu item
                selector: 'node, edge',
                onClickFunction: function (event) { // The function to be executed on click
                    let target = event.target || event.cyTarget;
                    // if ((target.data().class_name === "InputLayer") && !(target.data().name in Object.keys(inputs_layers)))
                    //     clear_input_modal(dict_wizard);
                    if (inputs_layers.hasOwnProperty(target.data().name)) {
                        delete inputs_layers[target.data().name];
                        reset_wizard();
                    }
                    target.remove();
                    $('#' + target.id()).remove();
                    disable_submit_button();
                    clean_blocks();
                },
                disabled: false, // Whether the item will be created as disabled
                hasTrailingDivider: true, // Whether the item will have a trailing divider
                coreAsWell: false // Whether core instance have this item on cxttap
            },
            {
                id: 'add-node',
                content: 'add node',
                tooltipText: 'add node',
                selector: 'node',
                coreAsWell: true,
                onClickFunction: function (event) {
                    add_new_node(event);

                }
            },
            {
                id: 'duplicate',
                content: 'duplicate',
                tooltipText: 'duplicate',
                selector: 'node',
                onClickFunction: function (event) {
                    let node = event.target || event.cyTarget;
                    if (node.data().class_name !== 'InputLayer')
                        duplicate(event);
                },
                disabled: false, // Whether the item will be created as disabled
                hasTrailingDivider: true, // Whether the item will have a trailing divider
                coreAsWell: false // Whether core instance have this item on cxttap
            },
            {
                id: 'group-nodes',
                content: 'group nodes',
                tooltipText: 'group selected nodes',
                selector: 'node',
                coreAsWell: true,
                disabled: false,
                onClickFunction: function (event) {
                    group_selected_nodes(event);
                    disable_submit_button();
                    add_icons_nodes();

                }
            },
            {
                id: 'ungroup-nodes',
                content: 'ungroup nodes',
                tooltipText: 'ungroup selected nodes',
                selector: 'node',
                coreAsWell: true,
                disabled: false,
                onClickFunction: function (event) {
                    let target = event.target || event.cyTarget;
                    target.children().forEach(function (c) {
                        c.move({'parent': null});
                    });
                    target.remove();
                    disable_submit_button();
                    add_icons_nodes();


                }
            },
            {
                id: 'add-input-data',
                content: 'add input data',
                tooltipText: 'add input data',
                selector: 'node',
                coreAsWell: true,
                disabled: false,
                onClickFunction: function (event) {
                    add_input_data(event);
                }
            }
        ]
    };
    let instances = cy.contextMenus(options);
    instances.hideMenuItem('group-nodes');
    instances.hideMenuItem('ungroup-nodes');
    instances.hideMenuItem('add-input-data');

    let eh = cy.edgehandles({snap: true});
    let ur = cy.undoRedo({undoableDrag: false});
    cy.clipboard();

    function deleteEles(eles) {
        return eles.remove();
    }

    function restoreEles(eles) {
        return eles.restore();
    }

    ur.action("deleteEles", deleteEles, restoreEles);


    document.addEventListener("keydown", function (e) {
        if ((e.ctrlKey || e.metaKey) && e.target.nodeName === 'BODY') {
            if (e.which === 67) // CTRL + C
            {

                let nodes = cy.$(":selected");
                let copy = true;
                nodes.forEach(function (node) {
                    if (node.data().class_name === 'InputLayer') {
                        copy = false;
                        return;
                    }
                });
                if (copy) cy.clipboard().copy(cy.$(":selected"));
            }

            else if (e.which === 86) {
                ur.do("paste");

            }// CTRL + V

            else if (e.which === 65) { // + A
                cy.elements().select();
                e.preventDefault();
            }
            disable_submit_button()
        } else if (e.which === 46 || e.which === 8) { // + Remove
            if ($(":focus").length === 0) {
                let node = cy.nodes().filter((node) => (node.selected()));
                if (node.length > 0) {
                    if (inputs_layers.hasOwnProperty(node.data().name)) {
                        delete inputs_layers[node.data().name];
                        reset_wizard();
                    }

                    $('#' + node.id()).remove();
                    disable_submit_button();
                }
                ur.do("deleteEles", cy.$(":selected"));
                clean_blocks();
            }


        }
    });
    document.addEventListener("click", function (e) {
        let selected = cy.nodes().filter((node) => (node.selected()));
        instances.hideMenuItem('ungroup-nodes');

        if (selected.length > 1) {
            instances.showMenuItem('group-nodes');

        } else {
            instances.hideMenuItem('group-nodes');
            if (selected.length === 1 && selected[0].data().class_name === 'block') {
                instances.showMenuItem('ungroup-nodes');
            }
        }
    });

    cy.on('cxttapstart', 'node', function (e) {
        e.target.select();
        instances.hideMenuItem('add-input-data');
        if (e.target.data().class_name === 'InputLayer') {
            instances.showMenuItem('add-input-data');
        }
    });

    // $('#nav-state-toggle').on('click', function () {
    //     add_icons_nodes();
    // });


    cy.on('doubleTap', 'node', function (event) {
        add_input_data(event)
    });

    function add_input_data(event) {
        if (event.target.data().class_name.includes('InputLayer')) {

            $('#modal').removeClass('fade');

            disable_submit_button();
            if (inputs_layers.hasOwnProperty(event.target.data().name) && inputs_layers[event.target.data().name].is_saved) {
                let name = event.target.data().name;

                $('#table_datasets').DataTable().rows().every(function () {
                    var data = this.data()[0];
                    if (inputs_layers[name].dataset === data) {
                        this.select();
                        $("#select_continue").prop('disabled', false);
                    }

                });
                wizard_next(2, dict_wizard);

                update_split(inputs_layers[name].split.split(','));

                if (inputs_layers[name].hasOwnProperty('df')) {
                    mode = 'tabular';
                    wizard_next(3, dict_wizard);
                    table_feat_created = create_features_table(inputs_layers[name]['df'], inputs_layers[name]['category_list'], dict_wizard);
                    table_target_created = create_target_table(inputs_layers[name]['df'], inputs_layers[name]['category_list'], inputs_layers[name]['targets'], dict_wizard);
                    $('#normalize').prop('checked', inputs_layers[name]['normalize']);
                    //$('#range-numerical').prop('checked', inputs_layers[name]['range-numerical']);
                } else {
                    mode = 'image';
                    restore_features_images(inputs_layers[name]['height'], inputs_layers[name]['width'], inputs_layers[name]['normalization'], inputs_layers[name]['augmentation_options'], inputs_layers[name]['augmentation_params']);
                    create_images_targets(inputs_layers[name]['image_data']);
                }
            } else {
                reset_wizard();
            }
            $('#modal').show();
        }
    }

    var tappedBefore;
    var tappedTimeout;
    $('#close').on('click', function () {
        clear_input_modal(dict_wizard, true);
        close_modal();
        let input_node = cy.$(':selected').data().name;
        if (inputs_layers.hasOwnProperty(input_node) && !inputs_layers[input_node].is_saved) {
            reset_wizard();
            delete inputs_layers[input_node];

        }

    });
    $('#table_datasets tbody').on('click', 'tr', function (e) {
        clear_input_modal(dict_wizard, false);
        reset_wizard();
        let input_node = cy.$(':selected').data().name;
        if (inputs_layers.hasOwnProperty(input_node) && !inputs_layers[input_node].is_saved) {
            delete inputs_layers[input_node];
        }
        let table_datasets = $('#table_datasets').DataTable();
        if (table_datasets.row(this, {selected: true}).any())
            $('#select_continue').prop('disabled', true);
        else if (table_datasets.page.info().recordsDisplay === 0) {
            $('#select_continue').prop('disabled', true);
        }
        else $("#select_continue").prop('disabled', false);

    });

    cy.on('tap', function (event) {
        let tappedNow = event.target;
        if (tappedTimeout && tappedBefore) {
            clearTimeout(tappedTimeout);
        }
        if (tappedBefore === tappedNow) {
            tappedNow.trigger('doubleTap');
            tappedBefore = null;
        } else {
            tappedTimeout = setTimeout(function () {
                tappedBefore = null;
            }, 300);
            tappedBefore = tappedNow;
        }
    });

    cy.on('tap', function (event) {
        let evtTarget = event.target;
        if (evtTarget === cy)
            add_new_node(event);
    });


    cy.on('tap', 'node', function (evt) {
        clear_properties();
        show_properties(evt.target.data().content, evt.target.id());
    });

    cy.on('ehcomplete', (event, sourceNode, targetNode, addedEles) => {
        if (targetNode.data().root === 'Input Layers') {
            addedEles.remove();
        } else if (targetNode.indegree() > 1 && !(targetNode.data().root === 'Merge Layers')) {
            addedEles.remove();
        } else if (sourceNode.data().root === 'Loss Functions') {
            addedEles.remove();
        } else if (targetNode.data().class_name === 'block' || sourceNode.data().class_name === 'block') {
            addedEles.remove();
        }
        disable_submit_button();
    });
    cy.on('drag', 'node', function (e) {
        add_icons_nodes();

    });
    cy.on('expandcollapse', function (e) {
        add_icons_nodes();
    });
    cy.on('expandcollapse.beforecollapse', function (e) {
        e.target.children().filter((n) => (n.isNode())).forEach(function (n) {
            var div = document.getElementById(n.id());
            if (div) {
                div.style.display = "none";
            }

        });
    });
    cy.on('expandcollapse.afterexpand', function (e) {
        e.target.children().filter((n) => (n.isNode())).forEach(function (n) {
            var div = document.getElementById(n.id());
            if (div) {
                div.style.display = "block";
            }

        });
    });
    $('.card').on('shown.bs.collapse', function (e) {
        var resizeEvent = window.document.createEvent('UIEvents');
        resizeEvent.initUIEvent('resize', true, false, window, 0);
        window.dispatchEvent(resizeEvent);
    });

    $('.card').on('hidden.bs.collapse', function (e) {
        var resizeEvent = window.document.createEvent('UIEvents');
        resizeEvent.initUIEvent('resize', true, false, window, 0);
        window.dispatchEvent(resizeEvent);
    });


    $('#properties').bind('input', function (e) {
        let id = $('#node_name').val();
        let new_value_id = e.target.id;
        let cy_element = cy.getElementById(id).data();
        if (is_valid(cy_element.content['type'], e.target.value, e.target.id, cy)) {
            e.target.classList.remove('invalid');
            if (!cy_element.content.hasOwnProperty(new_value_id)) {
                let param = new_value_id.split('-')[0];
                cy_element.content[param]['config'] = {};
                $.map($('#properties :input[id^=' + param + '-]'), function (i) {
                    let field = i.id.split('-')[1];
                    cy_element.content[param]['config'][field] = i.value;
                });

            } else {
                cy_element.content[new_value_id]['value'] = e.target.value;
                if (cy_element.content[new_value_id].hasOwnProperty('config'))
                    delete  cy_element.content[new_value_id]['config'];
                if (e.target.id === 'name') {
                    cy_element.name = e.target.value;
                    add_icons_nodes();
                }
            }

        } else
            e.target.classList.add('invalid');
        disable_submit_button();
    })
        .on('change', 'select', function (e) {
            let prop = this.name;
            let param = $(e.target).val();
            show_params_config(prop, param, null)
        })
        .on('click', 'select', function (e) {
            let prop = this.name;
            let param = $(e.target).val();
            let node = cy.nodes().filter((node) => (node.selected()));
            let config = null;
            if (node.data()['content'][prop].hasOwnProperty('config')) {
                config = node.data()['content'][prop]['config']
            }
            show_params_config(prop, param, config)
        });

    function group_selected_nodes(event) {
        let nodes = cy.nodes().filter((node) => (node.selected()));
        var content = {}
        content['name'] = {'type': 'text'};
        content['name']['value'] = "block_" + counters['block'].toString();
        let grp = cy.add({
            data: {
                name: "block_" + counters['block'].toString(),
                class_name: 'block',
                root: 'block',
                content: content

            }
        });
        counters['block'] += 1;

        //create parent node
        nodes.forEach(function (node) {
            node.move({parent: grp.data().id});
        });
        clean_blocks();


    }

    $('#clear_grid').on('click', function () {
        if (confirm('This action will clear all nodes and cannot be undone. Proceed?')) {
            cy.remove(cy.nodes());
        }


    });

    function clean_blocks() {
        let blocks = cy.nodes().filter((node) => (node.data().class_name === 'block' && node.children().length === 1));
        blocks.forEach(function (n) {
            n.children().forEach(function (c) {
                c.move({'parent': null});
            });
        });
        cy.remove(blocks);
    }


    function add_new_node(event) {
        let radio_checked = document.querySelector('input[name="radio"]:checked');
        if (radio_checked) {

            // ONE INPUT LAYER ALLOW
            if (radio_checked.id === 'InputLayer') {
                let exists = false;
                let c = cy.filter(function (element, i) {
                    if (element.isNode() && element.data().class_name === 'InputLayer') {
                        alert('Input layer already exists');
                        exists = true;
                    }
                });
                if (exists)
                    return false;
            }


            let id_checked = document.querySelector('input[name="radio"]:checked').id;
            let root = Object.keys(corelayers).find(key => id_checked in corelayers[key]);
            Object.keys(corelayers).forEach(function (key) {
                let content = $.extend(true, {}, corelayers[key][id_checked]);
                if (id_checked in corelayers[key]) {
                    if (id_checked === 'InputLayer' && 'input_shape' in content) {
                        content['input_shape']['value'] = appConfig.input_shape;
                    }
                    if (id_checked === 'DNN' && appConfig.hasOwnProperty('hidden_layers')) {
                        content['hidden_layers']['value'] = '[' + appConfig.hidden_layers + ']';
                    }
                    if (id_checked in counters) {
                        counters[id_checked] += 1;
                    } else {
                        counters[id_checked] = 0;
                    }
                    content['name'] = {'type': 'text'};
                    content['name']['value'] = id_checked + "_" + counters[id_checked].toString();
                    let new_node = cy.add({
                        group: "nodes",
                        data: {
                            name: id_checked + "_" + counters[id_checked].toString(),
                            class_name: id_checked,
                            root: root,
                            weight: 75,
                            content: content
                        },
                        position: event.position
                    });
                    disable_submit_button();
                }
                add_icons_nodes();
            });
        }
    }

    function duplicate(event) {
        cy.clipboard().copy(event.target || event.cyTarget);
        ur.do("paste");
        disable_submit_button();
        add_icons_nodes();
    }


    function add_icons_nodes() {
        cy.nodeHtmlLabel(Object.keys(fa_corelayers).map(function (key) {
                return {
                    query: "node[root = '" + key + "']",
                    tpl: function (data) {
                        return "<p class='icon_layer'> <i class='" + fa_corelayers[data.root] + "'> </i>" + data.name + "</p>"
                    }
                }
            })
        );
        zoom(cy, -0.000001);
    }


    $('#validate_model').on('click', async function (event) {
        validate_save_model(cy, event, api, false);
    });

    $('#save_model').on('click', async function (event) {
        let confirm_mess = 'This model is not validated yet. ' +
            'If you save it without validate will not possible to train it.' +
            ' Input data will not be saved.' +
            '\n Continue?';
        if (cy.nodes().length > 0) {
            if ($('#validate_model')[0].hidden) {
                // Save validated model
                validate_save_model(cy, event, api, true);
            } else if (confirm(confirm_mess)) {
                // Save without validate
                not_validate_save_model(cy, event, api);
            }
        } else {
            alert('Blank canvas can not be saved.')
        }
    });

    $('#inp').on('change', function () {
        if ($('#inp').val() === '') {
            $('#save_model').prop('disabled', true);
        } else {
            $('#save_model').prop('disabled', false);
        }

        disable_submit_button();
    });


    $('#zoom_handler').on('click', function () {
        center_layout(cy);
    });
    $('#zoom_horizontal_handler').on('click', function () {
        horizontal_layout(cy);
    });
    $('#zoom_plus').on('click', function () {
        zoom(cy, 0.1);
    });
    $('#zoom_minus').on('click', function () {
        zoom(cy, -0.1);
    });

    loaded_input = cy.filter(function (element, i) {
        if (element.isNode() && 'name' in element.data())
            if (element.data().class_name.includes('InputLayer') && element.data().content.input_shape.value !== undefined)
                return element.data('name');
        return false;
    });
    load_model_input();

});

function check_input_output(cy) {
    let input_nodes = cy.filter(function (element, i) {
        if (element.isNode() && 'name' in element.data())
            if (element.data().class_name.includes('InputLayer') && element.data().content.input_shape.value !== undefined)
                return true;
        return false;
    });
    let output_nodes = cy.filter(function (element, i) {
        if (element.isNode() && 'name' in element.data())
            if (element.data('name').includes('Loss'))
                return true;
        return false;
    });

    if (input_nodes.length !== 1)
        return 'Input layer not exists or  dataset not correctly added';

    if (input_nodes.length !== 1 || output_nodes.length !== 1)
        return 'Just one input layer and one loss layer are allowed';

    let canned_nodes = cy.nodes().filter((node) => (node.data().class_name in corelayers["Canned Models"]));
    let all = cy.nodes().filter((node) => ('class_name' in node.data()));

    if (canned_nodes.length === 1 && all.length > 3)
        return 'If you use a canned model it is not posible use another layer (besides input and loss)';
    return true;
}

function show_params_config(prop, param, saved_config) {
    var config;
    var prop_pre = prop.concat('-');
    $('#properties [id^=' + prop_pre + ']').remove();
    config = null;
    if (prop.includes('initializer')) {
        if (initializers.hasOwnProperty(param))
            config = initializers[param];
    } else if (prop.includes('regularizer')) {
        if (regularizers.hasOwnProperty(param))
            config = regularizers[param];
    } else if (prop.includes('constraint')) {
        if (constraints.hasOwnProperty(param))
            config = constraints[param];
    } else {
        return;
    }

    if (config !== null) {
        if (saved_config !== null) {
            Object.keys(config).forEach(function (key) {
                config[key]['value'] = saved_config[key]
            });
        }
        Object.keys(config).forEach(function (key) {
            append_after(key, config[key], prop); //param, config, parent
        });
    }
}


$(document).ready(function () {


    $('#select_continue').click(function (e) {
        $('#table_datasets').DataTable().rows({selected: true}).every(function () {
            appConfig.dataset = this.data()[0];
        });
        $(this).text('Loading data...');

        $.ajax({
            url: "/gui_select_data",
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json;charset=UTF-8',
            accepts: {
                json: 'application/json',
            },
            data: JSON.stringify({
                'dataset': appConfig.dataset,
            }),
            success: function (data) {
                $('#select_continue').text('Continue');

                // let input_node = cy.nodes().filter((node) => 'name' in node.data()).roots()[0];
                let input_node = cy.nodes().filter((node) => node.data().class_name === 'InputLayer')[0];
                inputs_layers[input_node.data('name')] = {'dataset': appConfig.dataset, 'is_saved': false};
                if (data.data.hasOwnProperty('height')) {
                    create_image_feature(data.data, dict_wizard);
                    mode = 'image';
                } else {
                    table_feat_created = create_features_table(data.data, null, dict_wizard);
                    mode = 'tabular';
                    inputs_layers[input_node.data('name')]['df'] = data.data;
                }

                appConfig['data_df'] = data.data;
                wizard_next(2, dict_wizard);

            }
        });
    });

    $('#splitTabContinue').click(function (e) {

        let train = $('#range1').val();
        let val = $('#range2').val();
        let test = $('#range3').val();
        appConfig.dataset_params.split = train + ',' + val + ',' + test;
        let input_node = cy.nodes().filter((node) => node.data().class_name === 'InputLayer')[0];
        // if (Object.keys(inputs_layers).length === 0) {
        //     inputs_layers[input_node.data('name')] = {}
        // }

        inputs_layers[input_node.data('name')]['split'] = appConfig.dataset_params.split;
        inputs_layers[input_node.data('name')]['train'] = train;
        inputs_layers[input_node.data('name')]['test'] = test;
        inputs_layers[input_node.data('name')]['validation'] = val;

        wizard_next(3, dict_wizard);
    });

    $('#featuresContinue').click(function (e) {
        if (mode === 'tabular') {
            tabular_features_continue();
        } else {
            image_features_continue();
        }

    });

    $('#table_features').on('change', '.selfeat', function () {
        let td = $(this).parent('td');
        let cell = $('#table_features').DataTable().cell(td);
        let k = $(this);
        k.find(`
    option[value = ${$(cell.data()).val()}]`).attr('selected', false);
        k.find(`
    option[value = ${$(this).val()}]`).attr('selected', true);
        cell.data(k.prop('outerHTML'));
    });

    $('#targetContinue').click(function (e) {
        if ($('#tabular_target').attr('hidden')) {
            inputs_layers[cy.$(':selected').data().name]['is_saved'] = true;
            close_modal();
            return true;
        }
        var targets = [];
        $('#table_targets').DataTable().rows({selected: true}).every(function () {
            targets.push(this.data()[0]);
        });
        if (targets.length > 0) {
            appConfig.dataset_params.targets = targets;
            inputs_layers[cy.$(':selected').data().name]['targets'] = appConfig.dataset_params.targets;
            let args = {};
            Object.keys(inputs_layers[cy.$(':selected').data().name]).forEach(function (k) {
                args[k] = inputs_layers[cy.$(':selected').data().name][k];
                if (['default_featu', 'cat_column', 'default_column'].contains(k))
                    args[k] = args[k].toArray();
            });
            $('#targetContinue').text('Saving changes...');

            $.ajax({
                url: "/gui_input",
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json;charset=UTF-8',
                accepts: {
                    json: 'application/json',
                },
                data: JSON.stringify(args),
                success: function (data) {
                    $('#targetContinue').text('Save');
                    if (data.error === false) {
                        appConfig.num_outputs = data.num_outputs;
                        appConfig.hidden_layers = data.hidden_layers;
                        let input_shape = data.input_shape;
                        $('#input_shape').val(input_shape);
                        cy.$(':selected').data()['content']['input_shape']['value'] = input_shape;
                        inputs_layers[cy.$(':selected').data().name]['targets'] = appConfig.dataset_params.targets;

                        inputs_layers[cy.$(':selected').data().name]['is_saved'] = true;
                        close_modal();
                    } else {
                        alert(data.error);
                    }

                }
                // error: function (xmlhttprequest, textstatus, message) {
                //     if (textstatus === "timeout") {
                //         $.notify("Time out", "error");
                //     }
                //     else if (textstatus === "error") {
                //         $.notify("Server error", "error");
                //     }
                //     else {
                //         $.notify("Error loading dataset", "error");
                //     }
                // }

            });
        } else
            alert('Select target!');
    });

    $("#submitform").submit(function (e) {
        let model_name = $('#inp').val();
        if (model_name === '') {
            e.preventDefault();
            alert('Model name can not be empty!');
            return false
        } else if (model_name in appConfig.parameters) {
            if (model_name === $("#model-toggler").text()) {
                alert('This model is currently running. Please stop the training before saving any changes.');
                return false;
            }
            if (!confirm('This model name already exists do yo want to overwrite it?'))
                return false;

        }
        $('#modelname').val(model_name);

        let canned_nodes = cy.nodes().filter((node) => (node.data().class_name in corelayers["Canned Models"]));
        $('#mode').val(canned_nodes.length);
    });

    function tabular_features_continue() {
        $('#image_target').attr('hidden', '');
        $('#tabular_target').removeAttr('hidden');
        let table = $('#table_features').DataTable();
        let cat_column = table.column('Category:name').data().map(b => $(b).val());
        let default_features = table.column('Features:name').data();
        let default_column = table.column('Defaults:name').data();

        appConfig.dataset_params.normalize = $('#normalize').is(":checked");

        let targets = null;
        if (appConfig.dataset_params !== null && appConfig.dataset_params.hasOwnProperty('targets'))
            targets = appConfig.dataset_params.targets;

        let cat_dict = {};
        table.rows().every(function () {
            cat_dict[this.data()[0]] = $(this.data()[1]).val();
        });

        table_target_created = create_target_table(appConfig.data_df, cat_dict, targets, dict_wizard);

        let input_node = cy.nodes().filter((node) => node.data().class_name === 'InputLayer')[0];
        inputs_layers[input_node.data('name')]['cat_column'] = cat_column;
        inputs_layers[input_node.data('name')]['category_list'] = cat_dict;
        inputs_layers[input_node.data('name')]['normalize'] = appConfig.dataset_params.normalize;
        inputs_layers[input_node.data('name')]['default_featu'] = default_features;
        inputs_layers[input_node.data('name')]['default_column'] = default_column;

    }

    function image_features_continue() {
        $('#image_target').removeAttr('hidden');
        $('#tabular_target').attr('hidden', '');
        let augmentation_options = [];
        let params = {};

        $.each($('#list2 a'), function (a, b) {
            if (b.id !== "")
                augmentation_options.push(b.id);
        });
        $('#list2 input[type="number"]').each(function () {
            let id_input = $(this)[0].id;
            if ($('#' + id_input).val() !== '')
                params[id_input] = $('#' + id_input).val();
            else {
                alert('Missing parameter value');
                throw 'Missing parameter value';
            }


        });
        $('#list2 input:checkbox, #list2 input[type="radio"]').each(function () {
            let id_input = $(this)[0].id;
            if (id_input !== '')
                params[id_input] = $('#' + id_input).is(":checked");
        });

        data = appConfig.data_df;

        let input_shape = "[" + $('#height').val() + ',' + $('#width').val() + ',' + data['n_channels'] + ']';
        $('#input_shape').val(input_shape);

        if (data.hasOwnProperty('num_outputs'))
            appConfig.num_outputs = data['num_outputs'];

        cy.$(':selected').data()['content']['input_shape']['value'] = input_shape;
        inputs_layers[cy.$(':selected').data().name]['normalization'] = $('#normalization').val();
        inputs_layers[cy.$(':selected').data().name]['augmentation_options'] = augmentation_options;
        inputs_layers[cy.$(':selected').data().name]['augmentation_params'] = params;
        inputs_layers[cy.$(':selected').data().name]['image_data'] = data.data;
        inputs_layers[cy.$(':selected').data().name]['height'] = $('#height').val();
        inputs_layers[cy.$(':selected').data().name]['width'] = $('#width').val();
        delete data['n_channels'];
        delete data['num_outputs'];
        create_images_targets(data.data);

    }
});

function zoom(cy, level) {
    let zoom = cy.zoom();
    cy.zoom({level: zoom + level});
}

function fit_layout(cy, rankDir=null) {
    let opts = {name: 'dagre'};
    if (rankDir !== null)
        opts['rankDir'] = rankDir;
    let layout = cy.layout(opts);
    layout.run();
    cy.maxZoom(1.2);
    cy.fit();
    cy.maxZoom(cy.maxZoom());
    cy.center();
}


function center_layout(cy) {
    let enodes = api.collapsibleNodes();
    api.collapse(enodes);
    fit_layout(cy);
    api.expand(enodes);
    fit_layout(cy);
}

function horizontal_layout(cy) {
    let enodes = api.collapsibleNodes();
    api.collapse(enodes);
    fit_layout(cy, 'LR');
    api.expand(enodes);
    fit_layout(cy, 'LR');
}

function sort_nodes(nodes) {
    let s = [];
    let explored = [];

    function dfs(node, explored, s) {
        explored.push(node);
        node.outgoers().forEach(n => {
            if (n.isNode() && explored.indexOf(n) < 0)
                dfs(n, explored, s);
        });
        s.push(node);
    }

    let input_nodes = nodes.filter((node) => 'name' in node.data()).roots();
    input_nodes.forEach(node => {
        if (explored.indexOf(node) < 0)
            dfs(node, explored, s);
    });
    s.reverse().forEach(function (el, idx) {
        el.data()['depth'] = idx;
    });
    return nodes.sort(function (a, b) {
        return a.data('depth') - b.data('depth');
    });
}


function send_canned(cy, dnn_nodes, cy_json, loss) {
    let input_node = cy.nodes().filter((node) => node.data().class_name === 'InputLayer')[0];
    inputs_layers[input_node.data('name')]['targets'] = appConfig.dataset_params.targets;

    let args = {};
    Object.keys(inputs_layers[input_node.data('name')]).forEach(function (k) {
        args[k] = inputs_layers[input_node.data('name')][k];
        if (['default_featu', 'cat_column', 'default_column'].contains(k))
            args[k] = args[k].toArray();
    });
    args['loss'] = loss;
    args['cy_model'] = cy_json;
    args['mode'] = 'canned';
    args['model_name'] = $('#inp').val();
    args['data'] = dnn_nodes.data().content;


    $('#save_model').text('Saving...')
        .addClass('disabled');
    $.ajax({
        url: "/save_model",
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json;charset=UTF-8',
        accepts: {
            json: 'application/json',
        },
        data: JSON.stringify(args),
        success: function (result) {
            $.notify("New model saved", "success");
            $('#save_model').text('Save').removeClass('disabled');
            appConfig.parameters = result.parameters;
            redraw_models_table('table_models', appConfig.parameters);
        },
        error: function (result) {
            $.notify('Model not saved', "error");
        }
    });
}


async function not_validate_save_model(cy, event, api) {
    if ($('#inp').val() in appConfig.parameters){
         if ($('#inp').val() === $("#model-toggler").text()) {
            alert('This model is currently running. Please stop the training before saving any changes.');
            return false;

        }
         if (!confirm('This model name already exists, it will be overridden. Continue?'))
        return false;

    }

    cy.remove(cy.nodes().filter((node) => (!('name' in node.data()))));

    let args = {};
    args['cy_model'] = cy.json();
    args['model_name'] = $('#inp').val();

    $('#save_model').text('Saving...')
        .addClass('disabled');
    $.ajax({
        url: "/save_no_val_model",
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json;charset=UTF-8',
        accepts: {
            json: 'application/json',
        },
        data: JSON.stringify(args),
        success: function (result) {
            $.notify("New model saved", "success");
            $('#save_model').text('Save').removeClass('disabled');
            appConfig.parameters = result.parameters;
            redraw_models_table('table_models', appConfig.parameters);
        }
    });
}


function check_correct_loss(loss_function, activation) {
    let loss_sug_function = 'mean_squared_error';
    let mode = 'regression';
    let target_type = null;
    let dataset = appConfig.hasOwnProperty('dataset') ? appConfig.dataset : appConfig.dataset_params.name;
    if (dataset === undefined) throw 'Please configure your dataset before validating';
    if (appConfig['user_dataset'][dataset].includes('images')) {
        target_type = 'categorical'

    } else {
        let targets = [];
        $('#table_targets').DataTable().rows({selected: true}).every(function () {
            targets.push(this.data()[0]);
        });
        if (targets.length === 0)
            targets.push(appConfig.dataset_params.targets[0]);
        target_type = Object.values(inputs_layers)[0]['category_list'][targets[0]];
    }


    if (target_type === 'categorical') {
        if (appConfig.num_outputs === 1) {
            loss_sug_function = 'sigmoid_cross_entropy';
        } else {
            loss_sug_function = 'softmax_cross_entropy';
        }
        mode = 'classification';
    }
    let message_warning;
    if (activation !== 'linear') {
        message_warning = "Use a 'Linear' activation function before your Loss Function.";
        $.notify("SUGGESTION : " + message_warning, "warning");
    }
    if (loss_function !== loss_sug_function) {
        message_warning = "Use  ' " + loss_sug_function + " ' as Loss Function for " + mode + " problems";
        $.notify("SUGGESTION : " + message_warning, "warning");
    }
}

async function validate_save_model(cy, event, api, save_model) {
    if ($('#inp').val() in appConfig.parameters && save_model) {
        if ($('#inp').val() === $("#model-toggler").text()) {
            alert('This model is currently running. Please stop the training before saving any changes.');
            return false;
        }
        if (!confirm('This model name already exists, it will be overridden. Continue?')) {
            return false;
        }
    }

    cy.remove(cy.nodes().filter((node) => (!('name' in node.data()))));

    let mess = check_input_output(cy);

    if (mess !== true) {
        alert(mess);
        disable_submit_button();
        return false;

    } else {
        let canned_nodes = cy.nodes().filter((node) => (node.data().class_name in corelayers["Canned Models"]));
        let canned_length = canned_nodes.length;
        if (canned_length === 1) {
            let input_canned = cy.filter(function (element, i) {
                if (element.isNode() && 'name' in element.data())
                    if (element.data().class_name.includes('InputLayer') && element.data().content.input_shape.value !== undefined)
                        return element.data();
                return false;
            });
            let is_image = input_canned.data().content.input_shape.value.split(',').length === 3;
            if (!is_image) {
                var loss = canned_nodes.successors().filter((node) => (node.data().hasOwnProperty('class_name') && node.data()['class_name'] === 'Loss')).data().content.function.value;

                check_correct_loss(loss, 'linear');


                $('#submit').removeAttr('hidden')
                    .prop('disabled', false);
                $('#validate_model').attr('hidden', '');
                if (save_model)
                    send_canned(cy, canned_nodes, cy.json(), loss);

            } else {
                alert('Canned Models can not be use with Image Input');
            }


        } else if (canned_length === 0) {
            let enodes = api.expandableNodes();
            api.expandAll();

            let loss_node = cy.nodes().filter((node) => (node.data('name').includes('Loss')));
            let edges = loss_node.connectedEdges();
            let loss_function = loss_node.data('content')['function'].value;
            cy.remove(loss_node);


            try {
                let nodes = cy.nodes().filter((node) => (node.data().class_name !== 'block'));
                let sorted_nodes = sort_nodes(nodes);
                let activation = '';
                let last_node = sorted_nodes[sorted_nodes.length - 1];
                if (last_node.data().content.hasOwnProperty('activation'))
                    activation = last_node.data().content.activation.value;
                check_correct_loss(loss_function, activation);

                let models = create_json_model(sorted_nodes);

                cy.add(loss_node);
                cy.add(edges);

                await tf_load_model(sort_nodes(nodes), models, loss_function, cy.json(), cy, loss_node, save_model);
                api.collapse(enodes);

            } catch (e) {
                cy.add(loss_node);
                cy.add(edges);
                api.collapse(enodes);
                alert(e);
            }
            event.preventDefault();
        }
        else {
            alert("Just one Canned Model allowed");
            disable_submit_button();
            return false;
        }
    }

}


async function tf_load_model(nodes, models, loss_function, cy_json, cy, loss_node, save_model) {
    let blob = new Blob([encode(JSON.stringify(models['tensorflowjs_json'], null, 4))], {
        type: 'application/octet-stream'
    });
    let url = URL.createObjectURL(blob);

    try {
        const model = await tf.loadLayersModel(url);
        let topology = model.toJSON(null, false);
        let model_json = {"modelTopology": topology};
        create_poppers(model.layers, nodes, cy, loss_node);

        let check_out = check_output(model.outputs[0].shape);
        if (!(check_out['val'])) {
            alert(check_out['mess']);
            disable_submit_button();
            return false;
        }

        if (save_model) {
            let input_node = cy.nodes().filter((node) => node.data().class_name === 'InputLayer')[0];
            inputs_layers[input_node.data('name')]['targets'] = appConfig.dataset_params.targets;
            let args = {};
            Object.keys(inputs_layers[input_node.data('name')]).forEach(function (k) {
                args[k] = inputs_layers[input_node.data('name')][k];
                if (['default_featu', 'cat_column', 'default_column'].contains(k))
                    args[k] = args[k].toArray();
            });
            args['loss_function'] = loss_function;
            args['model'] = model_json;
            args['cy_model'] = cy_json;
            args['mode'] = 'custom';
            args['model_name'] = $('#inp').val();


            $('#save_model').text('Saving model...')
                .addClass('disabled')
            $.ajax({
                url: "/save_model",
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json;charset=UTF-8',
                accepts: {
                    json: 'application/json',
                },
                data: JSON.stringify(args),
                success: function (result) {
                    $('#save_model').text('Save')
                        .removeClass('disabled')
                    if (result.explanation !== 'ok') {
                        alert(result.explanation);
                        disable_submit_button();
                        return false;
                    }
                    $.notify("New model saved", "success");
                    appConfig.parameters = result.parameters;
                    redraw_models_table('table_models', appConfig.parameters);
                }

            });
        }

        $('#submit').removeAttr('hidden')
            .prop('disabled', false);
        $('#validate_model').attr('hidden', '');

    } catch (error) {
        alert(error);
        disable_submit_button();
        return false;
    }
}

function disable_submit_button() {
    $('#submit').attr('hidden', '');

    $('#submit').prop('disabled', true);
    let $validate_model = $('#validate_model');
    $validate_model
        .removeAttr('hidden')
        .removeClass('btn-valid')
        .addClass('btn-secondary');
    $("div.popper-div").remove();
}

function check_output(model_shape) {
    let result = {};
    if (model_shape.length < 3) {
        result ['val'] = model_shape[model_shape.length - 1] === appConfig.num_outputs;
        result['mess'] = 'Output shape is not valid. Should be : ' + appConfig.num_outputs;
    } else {
        result ['val'] = false;
        result['mess'] = 'Output shape should have rank 2';
    }
    return result;
}

function create_popper(cy, node, id, text) {
    let makeDiv = function (text, id) {
        let div = $('<div></div>').attr('id', id)
            .addClass('popper-div')
            .text('(' + text + ')');
        $('#content').append(div);
        return div;
    };
    let popperA = node.popper({
        content: function () {
            return makeDiv(text, id);
        }
    });

    let updateA = function () {
        popperA.scheduleUpdate();
    };
    node.on('position', updateA);
    cy.on('pan zoom resize drag tap', updateA);
}

function create_poppers(layers, nodes, cy, loss_node) {
    $("div.popper-div").remove();
    let shapes = layers.map(function (layer) {
        if ('outputShape' in layer)
            return String(add_ba_size(layer.outputShape));
        return ''
    });
    zip([shapes, nodes]).map(p => create_popper(cy, p[1], p[1].id(), p[0]));
    let last_shape = shapes[shapes.length - 1].split(',');
    create_popper(cy, loss_node, loss_node.id(), 'None,' + last_shape[last_shape.length - 1]);
}

function node_name_exists(cy, value) {
    let nodes_names = cy.nodes().map(function (node) {
        return String(node.data('name'))
    });
    return nodes_names.indexOf(value) >= 0
}


function append_after(label_name, config, id_item_before) {
    let $label = $("<label>").text(label_name);
    $label.attr("id", id_item_before.concat('-').concat(label_name));
    if (config['type'] === "select") {
        let selectList = $("<select>")
            .attr('id', id_item_before.concat('-').concat(label_name))
            .attr('name', label_name);

        let option_list = config['options'].map((key) => $('<option>').val(key).text(key));
        selectList.append(option_list);
        selectList.attr('value', config['value']);
        selectList.appendTo($label);
        $('#' + id_item_before).after(selectList)
            .after($label);
        return;
    }

    let x = $('<input>')
        .attr("id", id_item_before.concat('-').concat(label_name))
        .attr("name", label_name)
        .attr("value", config['value']);
    x.appendTo($label);

    if (config['type'] === "float") {
        x.attr("type", "number")
            .attr("step", "0.001");
        if ('min' in config)
            x.attr("min", config['min']);
        if ('max' in config)
            x.attr("max", config['max']);
    } else if (config['type'] === "integer") {
        x.attr("type", "number")
            .attr("step", "1");
    }

    $('#' + id_item_before).after(x)
        .after($label);
}

// TODO validate different types
function is_valid(type, value, id, cy) {
    if (id === 'name' && node_name_exists(cy, value)) {
        return false;
    } else if (type === 'integer_list') {
        let list_number = RegExp('^\[[0-9]+(,[0-9]+)*\]$');
        let only_number = new RegExp('^[0-9]+$');
        return list_number.test(value) || only_number.test(value) || value === null || value === ''
    }
    return true;
}

function load_model_input() {
    $("#normalization").change(function () {
        $("#normalization option:selected").each(function () {
            $("#normalization_explain").html(this.title);
        });
    });


    wizard_next(1, dict_wizard);

    // Load model -> modal window
    if (!($.isEmptyObject(appConfig.data_df))) {

        update_split(appConfig.dataset_params.split.split(','));
        wizard_next(2, dict_wizard);
        if ('category_list' in appConfig.dataset_params) {
            mode = 'tabular';
            wizard_next(3, dict_wizard);

            table_feat_created = create_features_table(appConfig.data_df, appConfig.dataset_params.category_list, dict_wizard);
            table_target_created = create_target_table(appConfig.data_df, appConfig.dataset_params.category_list, appConfig.dataset_params.targets, dict_wizard);
            $('#normalize').prop('checked', appConfig.dataset_params.normalize);
            let table = $('#table_features').DataTable();
            let cat_column = table.column('Category:name').data().map(b => $(b).val());
            let default_features = table.column('Features:name').data();
            let default_column = table.column('Defaults:name').data();

            let input_nodes = cy.nodes().filter((node) => node.data().class_name === 'InputLayer');
            input_nodes.forEach(node => {
                let split = appConfig.dataset_params.split.split(',');
                inputs_layers[node.data('name')] = {
                    'dataset': appConfig.parameters[appConfig.m_name].dataset,
                    'split': appConfig.dataset_params.split,
                    'train': split[0],
                    'validation': split[1],
                    'test': split[2],
                    'df': appConfig.data_df,
                    'category_list': appConfig.dataset_params.category_list,
                    'normalize': appConfig.dataset_params.normalize,
                    'targets': appConfig.dataset_params.targets,
                    'default_featu': default_features,
                    'default_column': default_column,
                    'cat_column': cat_column,
                    'is_saved': true
                };
            });
        } else {
            mode = 'image';
            create_image_feature(appConfig.data_df, dict_wizard);
            restore_features_images(appConfig.dataset_params.height, appConfig.dataset_params.width, appConfig.dataset_params.normalization, appConfig.dataset_params.augmentation_options, appConfig.dataset_params.augmentation_params);
            create_images_targets(appConfig.data_df.data);
            // Supposed one input
            let split = appConfig.dataset_params.split.split(',');
            inputs_layers[loaded_input.data().name] = {
                'dataset': appConfig.dataset_params.name,
                'split': appConfig.dataset_params.split,
                'train': split[0],
                'validation': split[1],
                'test': split[2],
                'height': appConfig.dataset_params.height,
                'width': appConfig.dataset_params.width,
                'normalization': appConfig.dataset_params.normalization,
                'augmentation_options': appConfig.dataset_params.augmentation_options,
                'augmentation_params': appConfig.dataset_params.augmentation_params,
                'image_data': appConfig.data_df.data,
                'is_saved': true
            };
        }
        $('#validate_model').click();

    }
}
